bindir = ../bin
project = $(bindir)/asm
BISON ?= bison
FLEX ?= flex
override CFLAGS += 
override LDFLAGS +=
override YFLAGS +=
override LFLAGS +=

objdir = ./obj
override CFLAGS += -I$(objdir) -I.

y_src = assembler.y
lex_src = assembler.lex
c_src = $(wildcard *.c)
derived_c_src = $(objdir)/assembler.tab.c $(objdir)/lex.yy.c

c_objects = $(patsubst %, $(objdir)/%, $(c_src:.c=.o))
object = $(c_objects) $(derived_c_src:.c=.o)
deps = $(object:.o=.d)

.PHONY: all clean

all: $(project)

-include $(deps)

$(project): $(object) $(bindir)
	$(CC) $(LDFLAGS) $(object) -o $@

$(objdir)/%.o: %.c
	$(CC) $(CFLAGS) -MMD -c $< -o $@

$(objdir)/lex.yy.c: assembler.lex $(objdir)/assembler.tab.h
	$(FLEX) $(LFLAGS) -o $@ $<

# This rule keeps Make happy, while the %.tab.h file is generated by
#  the bison rule above
$(objdir)/%.tab.h: $(objdir)/%.tab.c
	if [ -e $@ ]; then touch $@; else false; fi

$(objdir)/assembler.tab.c: assembler.y
	$(BISON) $(YFLAGS) -o $@ -d $< 

$(derived_c_src): | $(objdir)
$(object): | $(objdir)

$(objdir):
	mkdir -p $@

$(bindir):
	mkdir -p $@

clean:
	rm -rf $(objdir)
	rm -f assembler.tab.c assembler.tab.h lex.yy.c $(project) $(project:=.exe)
